# Makefile for therapy-assistant-agent development tasks

.PHONY: help install install-dev lint format type-check security test test-unit test-integration test-cov clean build run dev docs pre-commit setup-hooks

# Default target
help:
	@echo "ğŸ¥ Therapy Assistant Agent - Development Commands"
	@echo "=================================================="
	@echo ""
	@echo "Setup Commands:"
	@echo "  install        Install production dependencies"
	@echo "  install-dev    Install development dependencies"
	@echo "  setup-hooks    Setup pre-commit hooks"
	@echo ""
	@echo "Code Quality Commands:"
	@echo "  lint           Run all linting tools"
	@echo "  format         Format code with black and isort"
	@echo "  type-check     Run type checking with mypy"
	@echo "  security       Run security analysis"
	@echo "  optimize       Run full optimization analysis"
	@echo ""
	@echo "Testing Commands:"
	@echo "  test           Run all tests"
	@echo "  test-unit      Run unit tests only"
	@echo "  test-integration Run integration tests only"
	@echo "  test-cov       Run tests with coverage report"
	@echo "  test-watch     Run tests in watch mode"
	@echo ""
	@echo "Development Commands:"
	@echo "  run            Run the application"
	@echo "  dev            Run in development mode"
	@echo "  migrate        Run database migrations"
	@echo "  seed           Seed database with test data"
	@echo ""
	@echo "Maintenance Commands:"
	@echo "  clean          Clean build artifacts"
	@echo "  build          Build the application"
	@echo "  docs           Generate documentation"

# Installation
install:
	@echo "ğŸ“¦ Installing production dependencies..."
	pip install -e .

install-dev:
	@echo "ğŸ“¦ Installing development dependencies..."
	pip install -e ".[dev,test,docs]"
	pip install pre-commit radon

setup-hooks:
	@echo "ğŸ”§ Setting up pre-commit hooks..."
	pre-commit install
	pre-commit install --hook-type commit-msg

# Code Quality
lint: 
	@echo "ğŸ§¹ Running linting tools..."
	python -m flake8 app tests scripts
	python -m bandit -r app -x "*/tests/*"

format:
	@echo "ğŸ¨ Formatting code..."
	python -m autoflake --remove-all-unused-imports --remove-unused-variables --remove-duplicate-keys --expand-star-imports --in-place --recursive app tests scripts
	python -m isort app tests scripts
	python -m black app tests scripts

type-check:
	@echo "ğŸ” Running type checking..."
	python -m mypy app

security:
	@echo "ğŸ”’ Running security analysis..."
	python -m bandit -r app -f json -o bandit-report.json || true
	python -m safety check --json --output safety-report.json || true
	@echo "Security reports generated: bandit-report.json, safety-report.json"

optimize:
	@echo "âš¡ Running full optimization analysis..."
	python scripts/lint_and_optimize.py --output optimization-report.json

# Testing
test:
	@echo "ğŸ§ª Running all tests..."
	python -m pytest

test-unit:
	@echo "ğŸ§ª Running unit tests..."
	python -m pytest tests/unit/ -m unit

test-integration:
	@echo "ğŸ§ª Running integration tests..."
	python -m pytest tests/integration/ -m integration

test-cov:
	@echo "ğŸ§ª Running tests with coverage..."
	python -m pytest --cov=app --cov-report=html --cov-report=term-missing --cov-report=xml

test-watch:
	@echo "ğŸ§ª Running tests in watch mode..."
	python -m pytest --tb=short -q --disable-warnings --no-header -x --lf

test-security:
	@echo "ğŸ§ª Running security tests..."
	python -m pytest -m security

test-performance:
	@echo "ğŸ§ª Running performance tests..."
	python -m pytest -m performance

# Development
run:
	@echo "ğŸš€ Starting application..."
	python -m uvicorn app.main_auth_async:app --reload --host 0.0.0.0 --port 8000

dev:
	@echo "ğŸ”§ Starting development server..."
	python -m uvicorn app.main_auth_async:app --reload --host 0.0.0.0 --port 8000 --log-level debug

run-web:
	@echo "ğŸŒ Starting web server..."
	python -m uvicorn app.main_web:app --reload --host 0.0.0.0 --port 8001

migrate:
	@echo "ğŸ—ƒï¸  Running database migrations..."
	alembic upgrade head

migrate-auto:
	@echo "ğŸ—ƒï¸  Generating automatic migration..."
	alembic revision --autogenerate -m "Auto migration"

migrate-rollback:
	@echo "ğŸ—ƒï¸  Rolling back last migration..."
	alembic downgrade -1

seed:
	@echo "ğŸŒ± Seeding database with test data..."
	python scripts/seed_database.py

# Maintenance
clean:
	@echo "ğŸ§¹ Cleaning build artifacts..."
	find . -type f -name "*.pyc" -delete
	find . -type d -name "__pycache__" -delete
	find . -type d -name "*.egg-info" -exec rm -rf {} +
	rm -rf build/
	rm -rf dist/
	rm -rf .pytest_cache/
	rm -rf .mypy_cache/
	rm -rf htmlcov/
	rm -rf .coverage
	rm -f *.log

build:
	@echo "ğŸ“¦ Building application..."
	python -m build

docs:
	@echo "ğŸ“š Generating documentation..."
	mkdocs build

docs-serve:
	@echo "ğŸ“š Serving documentation locally..."
	mkdocs serve

# Database utilities
db-reset:
	@echo "âš ï¸  Resetting database (WARNING: This will delete all data)..."
	@read -p "Are you sure? Type 'yes' to continue: " confirm && [ "$$confirm" = "yes" ]
	python -c "from app.core.database import db_manager; import asyncio; asyncio.run(db_manager.drop_tables())"
	alembic upgrade head

db-shell:
	@echo "ğŸ—ƒï¸  Opening database shell..."
	python -c "from app.core.database import db_manager; print('Database URL:', db_manager._get_database_url())"

# Quality gates
check-all: format type-check lint security test
	@echo "âœ… All quality checks passed!"

fix-all: format
	@echo "ğŸ”§ Auto-fixing code issues..."
	python scripts/lint_and_optimize.py --fix

# Docker commands
docker-build:
	@echo "ğŸ³ Building Docker image..."
	docker build -t therapy-assistant-agent .

docker-run:
	@echo "ğŸ³ Running Docker container..."
	docker run -p 8000:8000 therapy-assistant-agent

docker-dev:
	@echo "ğŸ³ Running Docker in development mode..."
	docker-compose up --build

# Monitoring
monitor-logs:
	@echo "ğŸ“Š Monitoring application logs..."
	tail -f app.log

monitor-metrics:
	@echo "ğŸ“Š Checking application metrics..."
	python -c "from app.core.database import db_metrics; print(db_metrics.get_metrics())"

# Deployment
deploy-staging:
	@echo "ğŸš€ Deploying to staging..."
	# Add staging deployment commands here

deploy-prod:
	@echo "ğŸš€ Deploying to production..."
	@echo "âš ï¸  Production deployment requires manual approval"
	# Add production deployment commands here

# Environment setup
env-setup:
	@echo "ğŸ”§ Setting up environment..."
	cp .env.example .env
	@echo "Please edit .env file with your configuration"

env-check:
	@echo "ğŸ” Checking environment configuration..."
	python -c "from app.core.config import get_settings; s = get_settings(); print('Environment OK' if s.SECRET_KEY != 'your-secret-key-change-in-production' else 'WARNING: Change SECRET_KEY')"

# Performance
profile:
	@echo "ğŸ“Š Running performance profiling..."
	python -m cProfile -o profile.stats -m uvicorn app.main_auth_async:app --host 127.0.0.1 --port 8000 &
	sleep 10
	curl http://localhost:8000/health
	pkill -f uvicorn
	python -c "import pstats; pstats.Stats('profile.stats').sort_stats('cumulative').print_stats(20)"

benchmark:
	@echo "ğŸƒ Running benchmarks..."
	python -m pytest tests/ -m performance --benchmark-only

# Git hooks
pre-commit-all:
	@echo "ğŸ”§ Running pre-commit on all files..."
	pre-commit run --all-files

# Help for specific commands
help-test:
	@echo "Testing Help:"
	@echo "  test           - Run all tests with default settings"
	@echo "  test-unit      - Run only unit tests (faster)"
	@echo "  test-integration - Run integration tests (slower)"
	@echo "  test-cov       - Generate coverage reports"
	@echo "  test-watch     - Continuously run tests on file changes"

help-quality:
	@echo "Code Quality Help:"
	@echo "  format         - Auto-format code (black, isort, autoflake)"
	@echo "  lint           - Check code style and potential issues"
	@echo "  type-check     - Verify type annotations"
	@echo "  security       - Scan for security vulnerabilities"
	@echo "  optimize       - Full analysis with recommendations"